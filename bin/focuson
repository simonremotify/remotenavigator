#!/usr/bin/python3

import argparse
import graphviz
import json
import os
import re

bindir = os.path.dirname(os.path.realpath(__file__))
defaultmodel = os.path.join(bindir, '..', 'model', 'model.rnm')

parser = argparse.ArgumentParser(description='Output a sub-graph with the given node as the focus.')
parser.add_argument('--model', default=defaultmodel)
parser.add_argument('--focus')
parser.add_argument('--allfoci', action='store_true')
parser.add_argument('--subset', action='append')
parser.add_argument('--outformat', default='svg')

args = parser.parse_args()

modelfile = open(args.model, 'r')
model = json.load(modelfile)

def makeInEdges(outedges):
    inedges = {}
    for source,targets in outedges.items():
        for outedgeparams in targets:
            target = outedgeparams['target']
            if target not in inedges:
                inedges[target] = []
            inedges[target].append({'source': source})

    return inedges

def findIncluded(nodes, outedges, inedges, focus):
    stack = [focus]
    included = set()

    # forward from focus
    while(len(stack)):
        current = stack.pop()
        included.add(current)

        if current not in outedges:
            continue
        currentoutedges = outedges[current]

        for outedgeparams in currentoutedges:
            target = outedgeparams['target']
            stack.append(target)

    stack = [focus]
    # back from focus
    while(len(stack)):
        current = stack.pop()
        if current != focus and current in included:
            continue
        included.add(current)

        print("Current ", current)

        if current not in inedges:
            continue
        currentinedges = inedges[current]

        for inedgeparams in currentinedges:
            source = inedgeparams['source']
            stack.append(source)

    return included

def subgraph(nodes, outedges, include):
    subgraphnodes = {k:v for (k,v) in nodes.items() if k in include}
    print("subgraphnodes ", subgraphnodes)

    subgraphoutedges = {source:[params for params in targets if params['target'] in include]
                            for (source,targets) in outedges.items() if source in include}

    return subgraphnodes, subgraphoutedges

def findKeysMatchingRegexp(map, regexp):
    return [k for k in map if re.match(regexp, k)]

type2shape = {'problem': 'hexagon',
              'practice': 'cds',
              'benefit': 'box'}
type2bgcolor = {'problem': '#325384',
                'practice': '#f0f0c9',
                'benefit': '#f33ad7'}
type2fontcolor = {'problem': '#dddddd',
                  'practice': '#111111',
                  'benefit': '#ffffff'}
type2margin = {'problem': '0.1',
                'practice': '0.3',
                'benefit': '0.22'}
edgetype2style = {'similar': 'dashed'}
edgetype2arrowhead = {'similar': 'none'}
edgetype2headlabel = {'detracts': '-'}
edgetype2color = {'detracts': 'black:invis:black'}
format2dpi = {'svg': '50',
              'png': '300'}


def toGraphviz(nodes, outedges):
    dot = graphviz.Digraph(format=args.outformat)
    dot.attr(rankdir='LR')
    dot.attr(dpi=format2dpi.get(args.outformat, '50'))
    dot.attr(bgcolor='#99999900')
    for (label,nodeinfo) in nodes.items():
        dot.node(label,
                 shape=type2shape.get(nodeinfo['type'], 'box'),
                 style='rounded,filled',
                 penwidth='0',
                 fillcolor=type2bgcolor.get(nodeinfo['type'], '#777777'),
                 fontcolor=type2fontcolor.get(nodeinfo['type'], '#ffffff'),
                 fontname='Exo',
                 margin=type2margin.get(nodeinfo['type'],'0.22'))
    for (source, targets) in outedges.items():
        for target in targets:
            dot.edge(source, target['target'],
                     tooltip=target.get('comment', ''),
                     style=edgetype2style.get(target.get('type', ''), ''),
                     arrowhead=edgetype2arrowhead.get(target.get('type', ''), ''),
                     color=edgetype2color.get(target.get('type', ''), ''),
                     headlabel=edgetype2headlabel.get(target.get('type', ''), ''))

    return dot

def renderGraphForFocus(nodes, outedges, inedges, focus):
    included = findIncluded(nodes, outedges, inedges, focus)
    g = toGraphviz(*subgraph(nodes, outedges, included))
    g.attr(label=focus)
    g.render('graph_' + focus)

nodes = model['nodes']
outedges = model['outedges']
inedges = makeInEdges(outedges)

g = toGraphviz(nodes, outedges)
g.render('whole_model')

if args.focus:
    focus = findKeysMatchingRegexp(nodes, args.focus)[0]
    renderGraphForFocus(nodes, outedges, inedges, focus)

if args.allfoci:
    for n in nodes:
        renderGraphForFocus(nodes, outedges, inedges, n)

if args.subset:
    for (i,subset) in enumerate(args.subset):
        included = subset.split(',')
        print("Subset ", included)
        g = toGraphviz(*subgraph(nodes, outedges, included))
        g.attr(rankdir='LR')
        g.render('subset_' + str(i))
